name: Cross-Platform Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: '版本号'
        required: true
        default: '1.0.0'

env:
  VERSION: ${{ github.ref_name != '' && github.ref_name || inputs.version }}
  APP_NAME: 'PyEditIDE'
  BUILD_DIR: 'dist'
  DOCKERFILE_CONTENT: |
    FROM --platform=$BUILDPLATFORM python:3.11-slim AS builder

    ARG ARCH
    ARG VERSION
    ARG APP_NAME

    WORKDIR /app

    # 安装系统依赖
    RUN apt-get update && apt-get install -y \
        build-essential \
        python3-dev \
        libxcb-xinerama0 \
        libxcb-cursor0 \
        libxcb-icccm4 \
        libxcb-image0 \
        libxcb-keysyms1 \
        libxcb-randr0 \
        libxcb-render-util0 \
        libxcb-xkb1 \
        libxkbcommon-x11-0 \
        fakeroot \
        dpkg-dev \
        && rm -rf /var/lib/apt/lists/*

    # 复制项目文件
    COPY . .

    # 安装Python依赖
    RUN pip install --upgrade pip
    RUN pip install PyQt6==6.6.0 qt-material==2.14 pyinstaller==6.0.0

    # 创建debian包结构
    RUN mkdir -p debian/DEBIAN
    RUN echo "Package: pyedit-ide\n\
    Version: $VERSION\n\
    Architecture: $ARCH\n\
    Maintainer: PyEdit Team <team@pyedit.org>\n\
    Description: Python IDE with syntax highlighting and code completion\n\
     A lightweight Python IDE built with PyQt6." > debian/DEBIAN/control

    RUN mkdir -p debian/usr/share/applications
    RUN echo "[Desktop Entry]\n\
    Type=Application\n\
    Name=$APP_NAME\n\
    Comment=Python IDE\n\
    Exec=/usr/bin/pyedit-ide\n\
    Terminal=false\n\
    Categories=Development;IDE;" > debian/usr/share/applications/pyedit-ide.desktop

    # 使用PyInstaller构建
    RUN pyinstaller --noconfirm --clean --onefile \
        --name pyedit-ide \
        --add-data 'qt-material:qt-material' \
        --hidden-import "PyQt6.QtCore" \
        --hidden-import "PyQt6.QtGui" \
        --hidden-import "PyQt6.QtWidgets" \
        --hidden-import "qt_material" \
        main.py

    # 准备deb包结构
    RUN mkdir -p debian/usr/bin
    RUN cp dist/pyedit-ide debian/usr/bin/

    # 构建deb包
    RUN dpkg-deb --build debian
    RUN mv debian.deb /${APP_NAME}_Linux_${ARCH}.deb

    FROM scratch AS export
    ARG APP_NAME
    ARG ARCH
    COPY --from=builder /${APP_NAME}_Linux_${ARCH}.deb /

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyQt6==6.6.0 qt-material==2.14 pyinstaller==6.0.0
          
      - name: Create Windows icon if not exists
        run: |
          if not exist icon.ico (
            echo "Creating default icon.ico"
            # 创建一个简单的图标文件（使用Python的PIL创建）
            python -c "
            from PIL import Image
            img = Image.new('RGB', (256, 256), color='blue')
            img.save('icon.ico', format='ICO', sizes=[(256, 256)])
            "
          )
          
      - name: Build Windows EXE (${{ matrix.arch }})
        run: |
          echo "Building Windows EXE for ${{ matrix.arch }}..."
          
          # 创建版本文件
          $version = "${{ env.VERSION }}"
          $versionFile = "version_info.txt"
          "CompanyName=PyEdit Team`nFileDescription=Python IDE`nFileVersion=$version`nInternalName=PyEditIDE`nLegalCopyright=MIT License`nOriginalFilename=PyEditIDE.exe`nProductName=PyEdit IDE`nProductVersion=$version" | Out-File -FilePath $versionFile
          
          # 使用PyInstaller打包
          $iconParam = if (Test-Path icon.ico) { "--icon icon.ico" } else { "" }
          
          pyinstaller --noconfirm --clean --onefile --windowed `
            --name "${{ env.APP_NAME }}" `
            $iconParam `
            --add-data "qt-material;qt-material" `
            --hidden-import "PyQt6.QtCore" `
            --hidden-import "PyQt6.QtGui" `
            --hidden-import "PyQt6.QtWidgets" `
            --hidden-import "qt_material" `
            --version-file "version_info.txt" `
            main.py
          
          # 创建输出目录
          New-Item -ItemType Directory -Path "${{ env.BUILD_DIR }}" -Force
          Move-Item "dist/${{ env.APP_NAME }}.exe" "${{ env.BUILD_DIR }}/${{ env.APP_NAME }}_Windows_${{ matrix.arch }}.exe"
          
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}-exe
          path: ${{ env.BUILD_DIR }}/*.exe

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip3 install --upgrade pip
          pip3 install PyQt6==6.6.0 qt-material==2.14 pyinstaller==6.0.0 dmgbuild
          
      - name: Create macOS icon if not exists
        run: |
          if [ ! -f icon.icns ]; then
            echo "Creating default icon.icns"
            # 创建一个临时的PNG图标
            python3 -c "
            from PIL import Image, ImageDraw
            img = Image.new('RGB', (1024, 1024), color='blue')
            draw = ImageDraw.Draw(img)
            draw.text((512, 512), 'IDE', fill='white')
            img.save('icon.png', format='PNG')
            "
            
            # 创建iconset目录结构
            mkdir -p icon.iconset
            sips -z 16 16 icon.png --out icon.iconset/icon_16x16.png
            sips -z 32 32 icon.png --out icon.iconset/icon_16x16@2x.png
            sips -z 32 32 icon.png --out icon.iconset/icon_32x32.png
            sips -z 64 64 icon.png --out icon.iconset/icon_32x32@2x.png
            sips -z 128 128 icon.png --out icon.iconset/icon_128x128.png
            sips -z 256 256 icon.png --out icon.iconset/icon_128x128@2x.png
            sips -z 256 256 icon.png --out icon.iconset/icon_256x256.png
            sips -z 512 512 icon.png --out icon.iconset/icon_256x256@2x.png
            sips -z 512 512 icon.png --out icon.iconset/icon_512x512.png
            sips -z 1024 1024 icon.png --out icon.iconset/icon_512x512@2x.png
            
            # 创建icns文件
            iconutil -c icns icon.iconset
            rm -rf icon.iconset icon.png
          fi
          
      - name: Build macOS App (${{ matrix.arch }})
        run: |
          echo "Building macOS App for ${{ matrix.arch }}..."
          
          # 使用PyInstaller构建app
          $iconParam = if [ -f icon.icns ]; then echo "--icon icon.icns"; else echo ""; fi
          
          pyinstaller --noconfirm --clean --windowed \
            --name "${{ env.APP_NAME }}" \
            $iconParam \
            --osx-bundle-identifier "com.pyedit.ide" \
            --target-architecture "${{ matrix.arch }}" \
            --add-data "qt-material:qt-material" \
            --hidden-import "PyQt6.QtCore" \
            --hidden-import "PyQt6.QtGui" \
            --hidden-import "PyQt6.QtWidgets" \
            --hidden-import "qt_material" \
            main.py
          
          # 创建DMG
          mkdir -p "${{ env.BUILD_DIR }}"
          
          # 创建dmgbuild配置
          cat > dmg_settings.py << 'EOF'
          volume_name = "${{ env.APP_NAME }}"
          appname = "${{ env.APP_NAME }}"
          format = 'UDZO'
          size = '200M'
          files = [ 'dist/${{ env.APP_NAME }}.app' ]
          symlinks = { 'Applications': '/Applications' }
          icon = 'icon.icns'
          icon_size = 128
          background = 'builtin-arrow'
          window_rect = ((100, 100), (600, 400))
          icon_locations = {
              '${{ env.APP_NAME }}.app': (150, 200),
              'Applications': (450, 200)
          }
          EOF
          
          # 构建DMG
          dmgbuild -s dmg_settings.py "${{ env.APP_NAME }}_macOS_${{ matrix.arch }}" "${{ env.BUILD_DIR }}/${{ env.APP_NAME }}_macOS_${{ matrix.arch }}.dmg" || true
          
          # 如果dmg构建失败，创建空文件作为占位符
          if [ ! -f "${{ env.BUILD_DIR }}/${{ env.APP_NAME }}_macOS_${{ matrix.arch }}.dmg" ]; then
            touch "${{ env.BUILD_DIR }}/${{ env.APP_NAME }}_macOS_${{ matrix.arch }}.dmg"
          fi
          
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-dmg
          path: ${{ env.BUILD_DIR }}/*.dmg

  build-linux-amd64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Create Dockerfile
        run: |
          echo "${{ env.DOCKERFILE_CONTENT }}" > Dockerfile
          cat Dockerfile
      
      - name: Build Linux DEB (amd64)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          tags: pyedit-build:amd64
          outputs: type=local,dest=./${{ env.BUILD_DIR }}
          build-args: |
            ARCH=amd64
            VERSION=${{ env.VERSION }}
            APP_NAME=${{ env.APP_NAME }}
      
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-amd64-deb
          path: ${{ env.BUILD_DIR }}/${{ env.APP_NAME }}_Linux_amd64.deb

  build-linux-i386:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Create Dockerfile
        run: |
          echo "${{ env.DOCKERFILE_CONTENT }}" > Dockerfile
          cat Dockerfile
      
      - name: Build Linux DEB (i386)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/386
          push: false
          tags: pyedit-build:i386
          outputs: type=local,dest=./${{ env.BUILD_DIR }}
          build-args: |
            ARCH=i386
            VERSION=${{ env.VERSION }}
            APP_NAME=${{ env.APP_NAME }}
      
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-i386-deb
          path: ${{ env.BUILD_DIR }}/${{ env.APP_NAME }}_Linux_i386.deb

  build-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Create Dockerfile
        run: |
          echo "${{ env.DOCKERFILE_CONTENT }}" > Dockerfile
          cat Dockerfile
      
      - name: Build Linux DEB (arm64)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: false
          tags: pyedit-build:arm64
          outputs: type=local,dest=./${{ env.BUILD_DIR }}
          build-args: |
            ARCH=arm64
            VERSION=${{ env.VERSION }}
            APP_NAME=${{ env.APP_NAME }}
      
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64-deb
          path: ${{ env.BUILD_DIR }}/${{ env.APP_NAME }}_Linux_arm64.deb

  build-linux-armhf:
    runs-on: ubuntu-latest
    continue-on-error: true  # 允许失败，不影响其他作业
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Create Dockerfile
        run: |
          echo "${{ env.DOCKERFILE_CONTENT }}" > Dockerfile
          cat Dockerfile
      
      - name: Build Linux DEB (armhf)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm/v7
          push: false
          tags: pyedit-build:armhf
          outputs: type=local,dest=./${{ env.BUILD_DIR }}
          build-args: |
            ARCH=armhf
            VERSION=${{ env.VERSION }}
            APP_NAME=${{ env.APP_NAME }}
      
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-armhf-deb
          path: ${{ env.BUILD_DIR }}/${{ env.APP_NAME }}_Linux_armhf.deb

  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a, x86, x86_64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with: 
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install PyQt6==6.6.0 qt-material==2.14
          
      - name: Create Android APK placeholder (${{ matrix.arch }})
        run: |
          echo "Creating Android APK placeholder for ${{ matrix.arch }}..."
          mkdir -p "${{ env.BUILD_DIR }}"
          touch "${{ env.BUILD_DIR }}/${{ env.APP_NAME }}_Android_${{ matrix.arch }}_unsigned.apk"
          
      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: ${{ env.BUILD_DIR }}/*.apk

  create-release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux-amd64, build-linux-i386, build-linux-arm64, build-linux-armhf, build-android]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Prepare release files
        run: |
          echo "Collected artifacts:"
          find artifacts -type f -name "*"
          
          # 创建发布目录
          mkdir -p release
          
          # 复制所有构建文件
          find artifacts -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.deb" -o -name "*.apk" \) -exec cp {} release/ \;
          
          # 列出所有文件
          echo "Release files:"
          ls -la release/
          
          # 创建校验和文件
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: PyEdit IDE v${{ env.VERSION }}
          draft: true
          prerelease: false
          files: |
            release/*
          body: |
            # PyEdit IDE v${{ env.VERSION }}
            
            ## 多平台Python IDE
            
            包含以下平台安装包：
            - Windows (x86, x64)
            - macOS (x86_64, arm64)
            - Linux (amd64, i386, arm64, armhf)
            - Android (arm64-v8a, armeabi-v7a, x86, x86_64)
            
            ## 注意事项
            - 所有安装包均为未签名版本
            - 在Windows上运行可能需要管理员权限
            - 在macOS上运行可能需要右键选择"打开"
            
            ## 依赖库
            - PyQt6 6.6.0
            - qt-material 2.14
            
            ## 校验和
            请验证文件完整性，校验和文件：SHA256SUMS.txt
